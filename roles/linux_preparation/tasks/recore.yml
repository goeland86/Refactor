---
- name: remove unneeded packages
  apt:
    pkg:
    - smartmontools
    state: absent
    autoremove: yes

- name: Recore - disable root login
  replace:
    path: /etc/ssh/sshd_config
    regexp: '^.*PermitRootLogin.*$'
    replace: '#PermitRootLogin'

- name: get date
  command: 'date --iso-8601'
  register: build_date

- name: Register ReFactor version
  script:
    cmd: '{{ role_path }}/files/get_refactor_version.sh'
  register: version

- name: write dogtag
  copy:
    dest: '/etc/{{ dogtag }}'
    content: '{{ version.stdout }} {{ build_date.stdout }}'

- name: set hostname
  copy:
    dest: /etc/hostname
    content: "{{ platform }}\n"

- name: write issue and issue.net
  copy:
    dest: '{{ item }}'
    content: |
      {{ version.stdout }}

      Check that nothing is printing before any intensive operation!
  with_items:
    - /etc/issue.net
    - /etc/issue

- name: Recore - add flashing scripts
  get_url:
    src: "https://raw.githubusercontent.com/intelligent-agent/Rebuild/main/userpatches/overlay/bins/{{ item }}"
    dest: /usr/local/bin
    mode: '0755'
  with_items:
    - get-boot-media
    - get-rootfs
    - get-serial-number
    - is-media-present
    - is-ssh-enabled
    - set-boot-media
    - set-ssh-access

- name: Recore - Fix haveged
  replace:
    path: /etc/default/haveged
    regexp: '"-w 1024"'
    replace: '"-w 1024 -d 16"'

- name: Recore - fix home ownership
  command: chown -R debian:debian /home/debian

- name: Recore - Create images directory
  file:
    path: "{{ debian.home }}/images"
    state: directory
    mode: '0755'
    owner: debian
    group: debian

- name: Recore - Create mount directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /mnt/emmc
    - /mnt/usb