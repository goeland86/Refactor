---
- name: Recore - Install packages
  apt:
    name:
      - libgpiod-dev
      - gpiod
      - git
      - virtualenv
      - python3-dev
      - libffi-dev
      - build-essential
      - libncurses-dev
      - libusb-dev
      - stm32flash
      - libnewlib-arm-none-eabi
      - binutils-arm-none-eabi
      - gcc-arm-none-eabi
      - pkg-config
      - python-libxml2
      - python-cffi
      - libc6-dev
    state: present

- name: Recore - give debian permissions to python folders for updates
  file:
    path: '{{ item }}'
    group: debian
    owner: debian
    mode: 0755
    recurse: yes
    state: directory
  with_items:
    - '{{ debian.home }}'
    - /usr/local/lib/python3
    - /usr/local/bin

- name: Recore - clone klipper from the repository
  git:
    repo: https://github.com/Klipper3d/klipper
    version: master
    dest: '{{ klipper_home }}'
    update: yes
    clone: yes

- name: Recore - add missing Recore py
  get_url:
    src: "https://raw.githubusercontent.com/intelligent-agent/klipper/master/klippy/extras/{{ item }}"
    dest: "{{ klipper_home }}/klippy/extras/{{ item }}"
    mode: '0644'
  with_items:
    - recore.py
    - thermocouple.py

- name: Recore - Add A5 compatibility
  get_url:
    src: "https://raw.githubusercontent.com/intelligent-agent/Rebuild/main/userpatches/overlay/klipper/{{ item }}"
    dest: "{{ klipper_home }}/klippy/extras/{{ item }}"
    mode: '0644'
  with_items: 
    - recore_a5.py
    - recore_adc_temperature.py
    - recore_thermistor.py
    - tmc2209_a5.py
    - tmc2130_a5.py

- name: Recore - add missing install script
  get_url:
    src: files/install-recore.sh
    dest: "{{ klipper_home }}/scripts/"
    mode: '0755'

- name: Recore - add config files
  get_url:
    src: "https://raw.githubusercontent.com/intelligent-agent/klipper/master/config/{{ item }}"
    dest: "{{ klipper_home }}/config/"
    mode: '0644'
  with_items:
    - generic-recore-a6.cfg
    - generic-recore-a7.cfg

- name: Recore - add config files
  get_url:
    src: "https://raw.githubusercontent.com/intelligent-agent/Rebuild/main/userpatches/overlay/klipper/{{ item }}"
    dest: "{{ klipper_home }}/config/"
    mode: '0644'
  with_items:
    - generic-recore-a5.cfg

- name: Recore - adjust ownership of klipper source
  file:
    path: "{{ klipper_home }}"
    owner: debian
    group: debian
    recurse: yes

- name: Recore - give debian user the klipper service permissions
  lineinfile:
    path: /etc/sudoers
    state: present
    line: "debian ALL=NOPASSWD: ALL"

- name: Recore - remove sudoers group authorization
  lineinfile:
    path: /etc/sudoers
    line: "%sudo   ALL=(ALL:ALL) ALL"
    state: absent

- name: Recore - Create virtual env
  shell: virtualenv -p python3 {{ debian.home }}/klippy-env
  become: true
  become_user: debian

- name: Recore - install requirements
  shell: "{{ debian.home }}/klippy-env/bin/pip install -r {{ debian.home }}/klipper/scripts/klippy-requirements.txt"
  become: true
  become_user: debian

- name: Recore - install Numpy
  shell: "{{ debian.home }}/klippy-env/bin/pip install numpy"

- name: Recore - Install klipper service file
  copy:
    src: "{{ role_path }}/files/klipper-recore.service"
    dest: "/etc/systemd/system/klipper.service"
    mode: '0644'

- name: Recore - Enable klipper service
  service:
    name: klipper.service
    enabled: yes

- name: Recore - Make firmware folder
  file:
    path: /opt/firmware
    state: directory
    mode: '0755'
    owner: debian
    group: debian

- name: Recore - Get and extract toolchain
  unarchive:
    src: http://feeds.iagent.no/toolchains/or1k-linux-musl.tar.xz
    dest: /opt/
    owner: debian
    group: debian
    remote_src: yes

- name: Recore - Copy AR100 config
  copy:
    src: "{{ role_path }}/files/ar100.config"
    dest: "{{ klipper_home }}/.config"
    owner: debian
    group: debian

- name: Recore - Compile AR100 binary
  shell: |
    export PATH=$PATH:/opt/output/bin
    echo "export PATH=$PATH:/opt/output/bin" >> /home/debian/.bashrc
    make olddefconfig
    make
  args:
    chdir: "{{ klipper_home }}"

- name: Recore - Copy AR100 binary
  copy:
    src: "{{ klipper_home }}/out/ar100.bin"
    dest: /opt/firmware/ar100.bin
    owner: debian
    group: debian
    remote_src: yes
    force: no

- name: Recore - Install bl31 binary
  copy:
    src: "{{ role_path }}/files/bl31.bin"
    dest: /opt/firmware/bl31.bin
    owner: debian
    group: debian

- name: Recore - Copy STM32 config
  copy:
    src: "{{ role_path }}/files/stm32f0.config"
    dest: "{{ klipper_home }}/.config"
    owner: debian
    group: debian

- name: Recore - Compile STM32 binary
  shell: |
    make olddefconfig
    make
  args:
    chdir: "{{ klipper_home }}"

- name: Recore - Copy STM32 binary
  copy:
    src: "{{ klipper_home }}/out/klipper.bin"
    dest: /opt/firmware/stm32.bin
    owner: debian
    group: debian
    remote_src: yes
    force: no

- name: Recore - Install stm32 flasher script
  copy:
    src: "{{ role_path }}/files/flash-stm32"
    dest: "/usr/local/bin"
    mode: '0755'

- name: Recore - Install stm32 flasher service
  copy:
    src: "{{ role_path }}/files/flash-stm32.service"
    dest: "/etc/systemd/system/"

- name: Recore - Enable stm32 flasher service
  service:
    name: flash-stm32.service
    enabled: yes

- name: Recore - Make Klipper config folder
  file:
    path: "{{ debian.home }}/printer_data/config/"
    state: directory
    mode: '0755'
    owner: debian
    group: debian